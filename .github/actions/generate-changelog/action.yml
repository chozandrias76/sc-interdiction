name: 'Generate Changelog'
description: 'Generate a categorized changelog from merged PRs'
inputs:
  previous-version:
    description: 'Previous version tag (without v prefix, leave empty for auto-detect)'
    required: false
    default: ''
  github-token:
    description: 'GitHub token for API access'
    required: true
outputs:
  changelog:
    description: 'Generated changelog in markdown format'
    value: ${{ steps.generate.outputs.changelog }}
runs:
  using: 'composite'
  steps:
    - name: Generate changelog
      id: generate
      shell: bash
      run: |
        # Get the previous tag from main branch (releases are tagged on main)
        if [ -n "${{ inputs.previous-version }}" ]; then
          PREV_TAG="v${{ inputs.previous-version }}"
        else
          PREV_TAG=$(git describe --tags --abbrev=0 origin/main 2>/dev/null || echo "")
        fi

        echo "Generating changelog from ${PREV_TAG:-initial commit} to HEAD"

        # Get list of PR numbers from git log between tags
        if [ -z "$PREV_TAG" ]; then
          PR_NUMBERS=$(git log --pretty=format:"%s" --no-merges | grep -oP '#\K[0-9]+' || echo "")
        else
          # Find merge base between current branch and main at previous tag
          MERGE_BASE=$(git merge-base HEAD origin/main 2>/dev/null || echo "$PREV_TAG")
          PR_NUMBERS=$(git log ${MERGE_BASE}..HEAD --pretty=format:"%s" --no-merges | grep -oP '#\K[0-9]+' || echo "")
        fi

        # Fetch PR details for each PR number
        MERGED_PRS=""
        for PR_NUM in $PR_NUMBERS; do
          PR_INFO=$(gh pr view $PR_NUM --json number,title 2>/dev/null | jq -r '"- #\(.number): \(.title)"' || echo "")
          if [ -n "$PR_INFO" ]; then
            MERGED_PRS="$MERGED_PRS$PR_INFO"$'\n'
          fi
        done

        # Categorize changes by conventional commit type
        CI_CHANGES=$(echo "$MERGED_PRS" | grep -E "^- #[0-9]+: (ci|build)" || echo "")
        FEAT_CHANGES=$(echo "$MERGED_PRS" | grep -E "^- #[0-9]+: feat" || echo "")
        FIX_CHANGES=$(echo "$MERGED_PRS" | grep -E "^- #[0-9]+: fix" || echo "")
        TEST_CHANGES=$(echo "$MERGED_PRS" | grep -E "^- #[0-9]+: (test|tests)" || echo "")
        DOCS_CHANGES=$(echo "$MERGED_PRS" | grep -E "^- #[0-9]+: docs" || echo "")
        CHORE_CHANGES=$(echo "$MERGED_PRS" | grep -E "^- #[0-9]+: chore" || echo "")
        REFACTOR_CHANGES=$(echo "$MERGED_PRS" | grep -E "^- #[0-9]+: refactor" || echo "")
        OTHER_CHANGES=$(echo "$MERGED_PRS" | grep -vE "^- #[0-9]+: (ci|build|feat|fix|test|tests|docs|chore|refactor)" || echo "")

        # Build changelog (without top-level header since it goes in Changes section)
        CHANGELOG=""

        if [ -n "$FEAT_CHANGES" ]; then
          CHANGELOG="$CHANGELOG### ‚ú® Features\n$FEAT_CHANGES\n\n"
        fi

        if [ -n "$FIX_CHANGES" ]; then
          CHANGELOG="$CHANGELOG### üêõ Bug Fixes\n$FIX_CHANGES\n\n"
        fi

        if [ -n "$CI_CHANGES" ]; then
          CHANGELOG="$CHANGELOG### üîß CI/CD & Build\n$CI_CHANGES\n\n"
        fi

        if [ -n "$TEST_CHANGES" ]; then
          CHANGELOG="$CHANGELOG### ‚úÖ Testing\n$TEST_CHANGES\n\n"
        fi

        if [ -n "$DOCS_CHANGES" ]; then
          CHANGELOG="$CHANGELOG### üìö Documentation\n$DOCS_CHANGES\n\n"
        fi

        if [ -n "$REFACTOR_CHANGES" ]; then
          CHANGELOG="$CHANGELOG### ‚ôªÔ∏è Refactoring\n$REFACTOR_CHANGES\n\n"
        fi

        if [ -n "$CHORE_CHANGES" ]; then
          CHANGELOG="$CHANGELOG### üî® Chores\n$CHORE_CHANGES\n\n"
        fi

        if [ -n "$OTHER_CHANGES" ]; then
          CHANGELOG="$CHANGELOG### üì¶ Other Changes\n$OTHER_CHANGES\n\n"
        fi

        # If no PRs found, fall back to commit messages
        if [ -z "$MERGED_PRS" ]; then
          CHANGELOG="$CHANGELOG### Commits\n"
          if [ -z "$PREV_TAG" ]; then
            CHANGELOG="$CHANGELOG$(git log --pretty=format:'- %s (%h)' --no-merges)\n"
          else
            CHANGELOG="$CHANGELOG$(git log ${PREV_TAG}..HEAD --pretty=format:'- %s (%h)' --no-merges)\n"
          fi
          CHANGELOG="$CHANGELOG\n"
        fi

        # Save changelog
        {
          echo 'changelog<<EOF'
          echo -e "$CHANGELOG"
          echo 'EOF'
        } >> $GITHUB_OUTPUT
      env:
        GH_TOKEN: ${{ inputs.github-token }}
